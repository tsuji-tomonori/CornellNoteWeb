# 単体テスト仕様書（JUnit + Mockito）

## 目的
- ドメイン/サービス層のロジックをJUnit + Mockitoで検証し、FRの受入基準とNFR-DEV-006の自動テスト網羅を満たす。

## 対象範囲
- バックエンドのユースケース実装（認証、ノートCRUD、検索、共有、PDFエクスポート）
- バリデーション/権限制御/エラー変換
- 依存外部I/FはMockitoでスタブ（DB、Object Storage、メール/SQS、外部IdP）

## 参照ドキュメント
- `docs/01-要件定義/3.機能要求(FR)/*`
- `docs/01-要件定義/2.プロジェクトの制約(PC)/PC-003.md`
- `docs/01-要件定義/4.非機能要求(NFR)/4.6.DevOps(DEV)/NFR-DEV-006.md`
- `docs/01-要件定義/4.非機能要求(NFR)/4.2.性能(PS)/NFR-PS-010.md`
- `docs/02-基本設計/4.API設計/API-Overview.md`
- `docs/02-基本設計/4.API設計/API-ErrorModel.md`
- `docs/03-詳細設計/1.UC別シーケンス/*`
- `docs/03-詳細設計/3.非機能詳細/DD-CICD-QualityGates.md`

## 前提/環境
- テストフレームワーク: JUnit 5
- モック: Mockito
- テストデータ: in-memory fixture

## テスト観点
- 正常系: 想定入力で正しい結果を返す
- 異常系: 権限/入力不備/存在しないID/トークン
- 境界値: 最大長、空/NULL、上限件数
- 例外変換: API-ErrorModelに従うエラーコード/メッセージ
- セキュリティ: ユーザー分離（PC-003）、共有リンク例外の扱い

## テストケース一覧

### 認証（UC-01, FR-AUTH-001/002/003）
| ID | 対象 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- |
| UT-AUTH-001 | signup() | 未登録メール | 正常入力で登録 | セッション作成、ユーザーID採番、ノート一覧遷移フラグを返す |
| UT-AUTH-002 | signup() | 既存メール | 同一メールで登録 | 重複エラーを返す |
| UT-AUTH-003 | login() | 登録済み | 正しいPWでログイン | セッション発行、ユーザーIDが一致 |
| UT-AUTH-004 | login() | 登録済み | 誤PW | 認証失敗エラーを返す |
| UT-AUTH-005 | login() | レート超過 | 連続失敗 | 429相当のエラーへ変換 |
| UT-AUTH-006 | logout() | ログイン済み | ログアウト実行 | セッションが無効化される |
| UT-AUTH-007 | requestPasswordReset() | 登録済み | 既存メールでリセット | リセットトークン生成、送信キュー登録 |
| UT-AUTH-008 | requestPasswordReset() | 未登録 | 未登録メール | 成功メッセージ固定（情報漏えい防止） |
| UT-AUTH-009 | resetPassword() | トークン有効 | 新PW設定 | パスワード更新、トークン無効化 |
| UT-AUTH-010 | resetPassword() | トークン期限切れ | 新PW設定 | 期限切れエラー |

### ノート作成/編集（UC-02/03, FR-COMMON-001/002/003, FR-EDIT-001〜004）
| ID | 対象 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- |
| UT-NOTE-001 | createNote() | ログイン済み | タイトル/Cue/Notes/Summaryを指定 | ノートID採番、初期メタデータ保存 |
| UT-NOTE-002 | updateNote() | 既存ノート | Cue更新 | Cueが永続化される |
| UT-NOTE-003 | updateNote() | 既存ノート | Notes更新 | Notesが永続化される |
| UT-NOTE-004 | updateNote() | 既存ノート | Summary更新 | Summaryが永続化される |
| UT-NOTE-005 | updateNote() | 既存ノート | タイトル更新 | 一覧/検索の反映フラグ更新 |
| UT-NOTE-006 | updateNote() | 既存ノート | 空タイトル | バリデーションエラー |
| UT-NOTE-007 | getNotes() | 既存ノート複数 | 一覧取得 | タイトル/更新日時を含む |
| UT-NOTE-008 | getNotes() | 大量データ | limit/offset指定 | ページングが適用される |
| UT-NOTE-009 | getNote() | 他ユーザーID | 取得 | 権限エラー（PC-003） |
| UT-NOTE-010 | getNote() | 存在しないID | 取得 | 404相当のエラー |
| UT-NOTE-011 | updateNote() | 他ユーザーID | 更新 | 権限エラー（PC-003） |
| UT-NOTE-012 | deleteNote() | 既存ノート | 削除実行 | 論理削除フラグ更新 |
| UT-NOTE-013 | getNoteContent() | 既存ノート | 本文取得 | Object Storage参照結果を返す |
| UT-NOTE-014 | updateNote() | ペイロード過大 | 1MB超 | 仕様どおりのエラー（NFR-PS-010） |

### 整理/検索（UC-04/05, FR-ORGANIZE-001/002, FR-SEARCH-001）
| ID | 対象 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- |
| UT-ORG-001 | createNotebook() | ログイン済み | ノートブック作成 | 作成後に参照可能 |
| UT-ORG-002 | assignNotebook() | 既存ノート | ノートへ割当 | ノートにNotebookIdが保存 |
| UT-ORG-003 | addTag() | 既存ノート | タグ追加 | 重複タグは無視 |
| UT-ORG-004 | removeTag() | 既存ノート | タグ削除 | タグが削除される |
| UT-SEARCH-001 | searchNotes() | 複数ノート | タイトル一致検索 | 対象ノートを返す |
| UT-SEARCH-002 | searchNotes() | 複数ノート | Cue/Notes/Summary一致 | 対象ノートを返す |
| UT-SEARCH-003 | searchNotes() | 複数ノート | tag/notebookId指定 | 絞り込み結果を返す |
| UT-SEARCH-004 | searchNotes() | 結果0件 | 不一致検索 | 空配列を返す |
| UT-SEARCH-005 | searchNotes() | 大量データ | limit/offset指定 | ページングが機能 |

### 共有リンク（UC-07, FR-SHARE-001/002）
| ID | 対象 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- |
| UT-SHARE-001 | createShareLink() | 既存ノート | 共有リンク生成 | トークン発行、期限/権限が設定 |
| UT-SHARE-002 | getSharedNote() | 有効トークン | 取得 | ログイン不要で閲覧データを返す |
| UT-SHARE-003 | getSharedNote() | 無効トークン | 取得 | 404/410エラー |
| UT-SHARE-004 | disableShareLink() | 有効トークン | 無効化 | 以後の取得が失敗 |
| UT-SHARE-005 | createShareLink() | 他ユーザーID | 共有実行 | 権限エラー（PC-003例外） |

### PDFエクスポート（UC-06, FR-EXPORT-001）
| ID | 対象 | 前提 | 手順 | 期待結果 |
| --- | --- | --- | --- | --- |
| UT-EXPORT-001 | requestPdfExport() | 既存ノート | エクスポート要求 | ジョブ登録、キュー送信 |
| UT-EXPORT-002 | buildPdfLayout() | 既存ノート | 変換実行 | Cue/Notes/Summaryが欠落しない |
| UT-EXPORT-003 | getExportStatus() | ジョブ実行中 | 状態確認 | 進捗/完了/失敗ステータスを返す |
| UT-EXPORT-004 | requestPdfExport() | 共有リンク経由 | エクスポート要求 | 権限エラー |

## 期待成果物
- JUnitレポート（XML/HTML）
- カバレッジレポート（80%以上）
- 失敗時のログ/モック呼び出し履歴
