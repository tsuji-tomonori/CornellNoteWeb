# インフラテスト仕様書（AWS CDK アサーション）

## 目的
- IaCで定義されたAWSリソースの構成/セキュリティ/可用性が設計どおりであることをアサーションテストで保証する。

## 対象範囲
- CDKスタック: フロントエンド/バックエンド/データ/ネットワーク
- 対象コンポーネント: CloudFront, S3, API Gateway, Lambda, RDS(Aurora Serverless), SQS, SES, WAF, IAM

## 参照ドキュメント
- `docs/01-要件定義/4.非機能要求(NFR)/4.6.DevOps(DEV)/NFR-DEV-001.md`
- `docs/01-要件定義/4.非機能要求(NFR)/4.3.セキュリティ(SEC)/NFR-SEC-004.md`
- `docs/01-要件定義/4.非機能要求(NFR)/4.3.セキュリティ(SEC)/NFR-SEC-011.md`
- `docs/01-要件定義/4.非機能要求(NFR)/4.5.可観測性(OPS)/NFR-OPS-005.md`
- `docs/02-基本設計/1.アーキテクチャ/ARCH-Deployment.md`
- `docs/02-基本設計/1.アーキテクチャ/ARCH-Logical.md`
- `docs/03-詳細設計/3.非機能詳細/DD-Security-Controls.md`
- `docs/03-詳細設計/3.非機能詳細/DD-Observability-Logging.md`

## 前提/環境
- AWS CDK Assertions (assertions.Template)
- 各環境(dev/stg/prod)の差分をパラメータで制御
- テストデータ: CDK synth成果物

## テスト観点
- セキュリティ: 暗号化、最小権限、WAF適用
- 可用性: Multi-AZ/冗長化設定
- 可観測性: ログ/メトリクス/アラーム
- コスト/性能: バージョニング/ライフサイクル/スケール設定
- 依存関係: API -> Lambda -> DB/S3, SQS -> Worker

## テストケース一覧

### エッジ/フロントエンド
| ID | 対象 | 期待される構成 | アサーション |
| --- | --- | --- | --- |
| INF-FE-001 | CloudFront | HTTPSのみ | ViewerProtocolPolicy=redirect-to-https |
| INF-FE-002 | CloudFront | TLS | MinimumProtocolVersion=TLSv1.2_2021 |
| INF-FE-003 | CloudFront | WAF適用 | WebACLIdが設定 |
| INF-FE-004 | S3静的 | 公開ブロック | BlockPublicAccess=TRUE |
| INF-FE-005 | S3静的 | OAI/OAC経由 | BucketPolicyにCloudFrontのみ許可 |
| INF-FE-006 | S3静的 | バージョニング | VersioningConfiguration=Enabled |
| INF-FE-007 | S3静的 | 暗号化 | SSE-S3またはSSE-KMS設定 |

### API/アプリ
| ID | 対象 | 期待される構成 | アサーション |
| --- | --- | --- | --- |
| INF-API-001 | API Gateway | ステージ設定 | AccessLogSettingsが有効 |
| INF-API-002 | API Gateway | WAF適用 | WebACLIdが設定 |
| INF-API-003 | API Gateway | レート制限 | UsagePlan/Throttle設定 |
| INF-API-004 | Lambda API | VPC内 | VpcConfigが存在 |
| INF-API-005 | Lambda API | 追跡 | Tracing=Active |
| INF-API-006 | Lambda API | 同時実行制御 | ReservedConcurrentExecutionsが設定 |
| INF-API-007 | Lambda API | 環境分離 | 環境変数にSTAGE設定 |
| INF-API-008 | Lambda API | ログ保持 | LogGroup Retention >= 30日 |
| INF-API-009 | Lambda API | 最小権限 | IAM Policyが最小権限 |

### データ/ストレージ
| ID | 対象 | 期待される構成 | アサーション |
| --- | --- | --- | --- |
| INF-DATA-001 | RDS/Aurora | Multi-AZ | MultiAZ=true |
| INF-DATA-002 | RDS/Aurora | 暗号化 | StorageEncrypted=true |
| INF-DATA-003 | RDS/Aurora | バックアップ | BackupRetentionPeriod>=7 |
| INF-DATA-004 | RDS/Aurora | プライベート | PubliclyAccessible=false |
| INF-DATA-005 | RDS/Aurora | ログ | CloudWatchLogsExports有効 |
| INF-DATA-006 | S3 Object | 暗号化 | SSE設定 |
| INF-DATA-007 | S3 Object | ライフサイクル | 90日移行/削除設定 |

### 非同期/通知
| ID | 対象 | 期待される構成 | アサーション |
| --- | --- | --- | --- |
| INF-ASYNC-001 | SQS | DLQ設定 | RedrivePolicyが存在 |
| INF-ASYNC-002 | SQS | 暗号化 | SSE有効 |
| INF-ASYNC-003 | Worker Lambda | キュー連携 | EventSourceMappingが存在 |
| INF-ASYNC-004 | SES | 送信元ドメイン | Identityが存在 |

### 監視/運用
| ID | 対象 | 期待される構成 | アサーション |
| --- | --- | --- | --- |
| INF-OPS-001 | CloudWatch | 主要アラーム | Alarmが定義 |
| INF-OPS-002 | Logs | アクセスログ | LogGroup/Retentionあり |
| INF-OPS-003 | WAF | 基本ルール | ManagedRuleGroupが適用 |
| INF-OPS-004 | IAM | 変更禁止 | 管理者権限が付与されていない |

## 期待成果物
- CDK Assertionレポート
- synthテンプレート（JSON）
- 構成差分一覧（dev/stg/prod）
