# 可用性設計（NFR-AV）

## 対応NFR
- NFR-AV-001 可用性SLO（99.9%/月）
- NFR-AV-002 冗長化（単一障害点の排除：AZ分散）
- NFR-AV-003 自動フェイルオーバ
- NFR-AV-004 縮退運転（Graceful Degradation）
- NFR-AV-005 バックアップ取得と保持（日次、90日以上）
- NFR-AV-006 災害復旧（RTO<=4h / RPO<=15m、年2回以上のDRテスト）
- NFR-AV-007 フェイルオーバ訓練（四半期1回以上）
- NFR-AV-008 タイムアウト/リトライ/遮断（標準化）
- NFR-AV-009 バックアップ復元テスト（四半期1回以上）
- NFR-AV-010 無停止リリース（計画停止の最小化）

## 目的
ユーザーが主要機能（ログイン、ノート閲覧/編集/検索）を継続的に利用できる状態を、SLOとして定義し、達成する。

## 可用性SLO（基本設計レベル）
- 月次SLO: 99.9%
- 対象: 主要APIと主要画面（NFR-OPS-002のSLI定義と整合）
- 計測: API成功率/エラー率/遅延、合成監視またはRUMで補完
- ダウンタイムの定義: 「主要機能が利用不可」または「SLOで定義する失敗条件（5xx/タイムアウト等）」

## 冗長化/単一障害点排除（AV-002）
- マネージド/リージョナル冗長なサービスを優先（API Gateway/Lambda/S3等）
- DBはMulti-AZ構成を前提（自動フェイルオーバ可能な構成）
- 非同期処理はキュー（SQS等）＋ワーカーで分離し、障害の影響範囲を限定

## 自動フェイルオーバ（AV-003）
- DB: 自動フェイルオーバを有効化し、アプリ側は接続再試行（標準リトライポリシー）で追随
- アプリ: ヘルスチェック（NFR-OPS-005）に基づき異常インスタンスを切り離し
- 依存先: 外部IdP/メール等はタイムアウト・遮断（AV-008）で波及を抑制

## 縮退運転（AV-004）
- クリティカル機能: ログイン、ノート閲覧、ノート編集（自動保存は回数/頻度を下げる）
- 準クリティカル機能: 検索（結果件数制限・タイムアウト短縮など）
- 非クリティカル機能: PDFエクスポート、メール送信等（キュー滞留を許容し遅延提供）
- 縮退時の振る舞い
  - 429/503など標準エラー（API-ErrorModel準拠）
  - UIには「処理遅延」「再試行」「問い合わせID（traceId）」を提示（NFR-UX-001）

## バックアップ/保持（AV-005）
- DB: 日次バックアップ、保持90日以上
- Object Storage: バージョニング/ライフサイクルと整合（NFR-COST-005とも連携）
- バックアップの成功/失敗は監視対象（NFR-OPS-003で通知）

## DR（AV-006）
- 目標: RTO<=4時間、RPO<=15分
- 手段（基本設計レベルの選択肢）
  - DB: PITR + レプリケーション/クロスリージョンバックアップ（データ所在地NFR-PRC-005と整合が必須）
  - Object Storage: クロスリージョン複製またはバックアップ（同上）
- DRテスト: 年2回以上（手順・結果・課題を保存＝監査エビデンスNFR-PRC-008）

## 訓練/テスト（AV-007, AV-009）
- フェイルオーバ訓練: 四半期1回以上（DBフェイルオーバ、依存サービス遮断等）
- 復元テスト: 四半期1回以上（DB復元＋業務データ整合性チェック）
- 記録: チケット/レポートを保管し、監査要求に5営業日以内で提示可能にする（NFR-PRC-008）

## タイムアウト/リトライ/遮断の標準（AV-008）
- タイムアウト: 依存先ごとに上限を定義（例：外部APIは短め）
- リトライ: 最大3回、指数バックオフ、ジッター、冪等性が前提（NFR-DATA-002と整合）
- Circuit Breaker: エラー率/連続失敗で遮断、半開で復帰
- 例外方針: リトライ禁止（非冪等の更新）などを明文化

## 無停止リリース（AV-010）
- 段階的リリース（NFR-DEV-003）＋迅速ロールバック（NFR-DEV-004）を標準
- DB変更は「後方互換」（NFR-DEV-005）に従い、Expand/Contractを原則とする
