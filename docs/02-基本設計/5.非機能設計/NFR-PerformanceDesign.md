# 性能設計（NFR-PS）

## 対応NFR
- NFR-PS-001 API応答時間（p95 300ms以下：サーバ処理）
- NFR-PS-002 画面応答（p95 2.0s以下：ユーザ体感）
- NFR-PS-003 スループット（200 rps）
- NFR-PS-004 オートスケール（5分以内に安定）
- NFR-PS-005 レート制御（429等の標準化）
- NFR-PS-006 性能/負荷試験（リリースゲート）
- NFR-PS-007 DB主要クエリ（p95 100ms以下）
- NFR-PS-008 起動時間（Ready 60秒以内）
- NFR-PS-009 バッチ完了（運用ウィンドウ内）
- NFR-PS-010 APIペイロード制限（1MB以下）

## 設計原則
- 体感性能（PS-002）とサーバ性能（PS-001）を分けてSLO/SLIを定義する（NFR-OPS-002と統合）。
- 「速くする」ではなく「遅くならない仕組み（上限/隔離/非同期）」を標準化する。

## API性能（PS-001）
- APM/トレーシングで主要APIのp95サーバ処理時間を計測
- ボトルネックがDB/外部依存の場合は、(1)クエリ改善、(2)キャッシュ、(3)非同期化、(4)縮退 を優先

## 体感性能（PS-002）
- RUMまたは合成監視で主要操作のp95を計測
- 前提条件（端末/回線/ブラウザ）を「サポートマトリクス」として明記（NFR-UX-002）

## スループット/スケール（PS-003, PS-004, PS-008）
- API Gateway + Lambdaのスケール特性を前提に、DBがボトルネックにならない設計を採る
- オートスケールの安定条件（5分以内）を満たすよう、コネクション制御/クエリ最適化/バースト制限を設計
- 起動60秒（Ready）は、依存初期化を最小化（コールドスタート対策）し、ヘルスチェックでReady判定

## レート制御（PS-005）
- クライアント単位の制限（IP/ユーザ/トークン等）を定義
- 超過時はHTTP 429、エラー体系はAPI-ErrorModelに統一
- WAF/エッジとアプリ層の二段構え（NFR-SEC-011とも整合）

## DB性能（PS-007）
- 「主要クエリ一覧」を作成し、p95 100msを目標に監視する（APM/DBメトリクス）
- インデックス設計、検索のページング、N+1回避を標準化

## バッチ（PS-009）
- バッチはキュー駆動＋ワーカーで実行し、ウィンドウ内完了を監視（実行時間推移をメトリクス化）

## ペイロード制限（PS-010）
- Request/Response 1MB以下を原則
- 例外（大容量）は署名URLでObject Storageへ逃がす、またはストリーミング方式
- 互換性（NFR-DEV-005）とセットで運用

## 性能試験（PS-006）
- リリース前に合意シナリオで負荷試験を実施
- 合否基準: PS-001/003を満たし、エラー率・スローダウンが許容内
- 結果は保存し、監査要求に提示可能にする（NFR-PRC-008）
