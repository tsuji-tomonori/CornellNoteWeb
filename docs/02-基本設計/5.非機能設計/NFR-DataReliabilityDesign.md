# データ信頼性設計（NFR-DATA）

## 対応NFR
- NFR-DATA-001 データ整合性（制約/検証）
- NFR-DATA-002 更新系APIの冪等性（Should）
- NFR-DATA-003 メッセージ処理の重複排除（Should）
- NFR-DATA-004 移行/マイグレーションの検証（Must）
- NFR-DATA-005 監査フィールド/変更履歴（Should）

## 整合性（DATA-001）
- DB制約（NOT NULL、UNIQUE、参照整合性）とアプリ検証を併用
- 不正入力が保存されないことをテストで担保

## 冪等性（DATA-002）
- 再送が起き得る更新系APIは冪等キー等で重複処理を防止
- リトライ標準（NFR-AV-008）と整合（冪等でない操作はリトライ禁止）

## 重複排除（DATA-003）
- イベント/キュー処理は at-least-once を前提に、重複投入でも結果が壊れない設計
- 重複排除キー、処理済み記録、冪等処理のいずれかを採用

## 移行検証（DATA-004）
- 件数、参照整合性、主要集計値の一致をチェックリスト化
- 移行ごとに結果を保存（監査エビデンス）

## 監査フィールド（DATA-005）
- 主要テーブルに createdAt/updatedAt/createdBy/updatedBy を保持
- 変更履歴が必要な対象一覧を明記
- 個人情報削除（PRC-003）と矛盾が出る場合の扱いを定義（匿名化等）
